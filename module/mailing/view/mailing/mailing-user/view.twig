{% do headTitle().append(translate("txt-admin")) %}
{% do headTitle().append(translate("txt-user-%s-in-mailing-%s")|format(mailingUser.user.displayName,mailingUser.mailing)) %}

<h1>{{ translate("txt-user-%s-in-mailing-%s")|format(mailingUser.user.displayName,mailingUser.mailing)|raw }}</h1>

<dl class="dl-horizontal">
    <dt>{{ translate("txt-mailing") }}</dt>
    <dd>{{ mailingLink(mailingUser.mailing,'view','name') }} <i
                class="fa fa-paper-plane-o sendSingle"
                data-mailing-user="{{ mailingUser.id }}"></i></dd>
    <dt>{{ translate("txt-subject") }}</dt>
    <dd>{{ mailingUser.mailing.mailSubject }}</dd>
    <dt>{{ translate("txt-user") }}</dt>
    <dd>{{ userLink(mailingUser.user,'view-admin','name') }}</dd>
    <dt>{{ translate("txt-email-address") }}</dt>
    <dd>{{ mailingUser.user.email }}</dd>
    <dt>{{ translate("txt-date-sent") }}</dt>
    <dd id="date-send-{{ mailingUser.id }}">{{ mailingUser.dateSent|string_date }}</dd>
    <dt>{{ translate("txt-hash") }}</dt>
    <dd>{{ mailingUser.hash }}</dd>
</dl>

{% if mailingUser.emailMessage.count() > 0 %}
    <h2>{{ translate("txt-email-tracking") }}</h2>

    <table class="table table-striped table-sm table-hover">
        <thead>
        <tr>
            <th>{{ translate("txt-id") }}</th>
            <th>{{ translate("txt-email-address") }}</th>
            <th>{{ translate("txt-date") }}</th>
            <th>{{ translate("txt-subject") }}</th>
            <th colspan="2">{{ translate("txt-latest-event") }}</th>
        </tr>
        </thead>
        <tbody>
        {% for emailMessage in mailingUser.emailMessage %}
            <tr>
                <td>{{ emailMessage.id }}</td>
                <td>{{ emailMessageLink(emailMessage,'view','emailAddress') }}</td>
                <td>{{ emailMessage.dateCreated|date('d-m-Y H:i:s') }}</td>
                <td>{{ emailMessageLink(emailMessage,'view','subject') }}</td>

                <td>{% if  emailMessage.latestEvent %}{{ emailMessageEventIcon(emailMessage) }}{% endif %}</td>
                <td>{% if  emailMessage.latestEvent %}{{ emailMessage.latestEvent }}
                        ({{ emailMessage.dateLatestEvent|date('d-m-Y H:i:s') }}){% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endif %}

<style type="text/css">
    i.sendSingle {
        cursor: pointer;
    }

    i.sendSingle:hover {
        color: #00a651;
    }
</style>

<script type="text/javascript">
    $(document).on('click', '.sendSingle', function (e) {
        let $this = $(this);

        $this.addClass('fa-spin');

        $.ajax({
            url: '{{ serverUrl() }}{{ url('json/mailing/send-single') }}',
            type: 'post',
            dataType: 'json',
            data: {
                'mailingUserId': $this.data('mailing-user')
            },
            success: function (response) {
                $this.removeClass('fa-spin');
                $('#date-send-' + response.data.id).html(response.data.dateSend)

            },
            error: function (xhr) {
                console.log(xhr);
                alert('Error! Did you enable adblock????? Status = ' + xhr.status);
            }
        });
    });
</script>
